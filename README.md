# pymongo-api

## Задание 1. Планирование

### Шаг 1. Шардирование в MongoDB

Для повышения производительности в MongoDB используется **шардирование** (горизонтальное партиционирование).  
В рамках данной практики задействованы два шарда. Метод шардирования выбран **хешированный** (Hash Sharding).  
Хеш-функция распределяет данные таким образом, чтобы каждая запись попадала на один из шаров на основе вычисленного хеш-значения.

**Схема шардирования** (первый вариант) доступен в [Google Drive](https://drive.google.com/file/d/1pNo0Ynpk6ZjZftUZAoFlRIByqkp8VaI3/view?usp=share_link) на странице `sharding`.

### Шаг 2. Репликация в MongoDB

Для повышения отказоустойчивости в каждом шарде применяется **репликация** (Replica Set).
- **Первичный (master)** узел отвечает за все операции записи и управление данными.
- **Вторичный (slave)** узел пассивно реплицирует данные от первичного узла и может обслуживать запросы на чтение.
- MongoDB использует heartbeat-сообщения для мониторинга состояния серверов и автоматического восстановления после сбоев.

Для полноценного шардированного решения необходимы дополнительные сервисы:

- **Router (router01)**: определяет, на какой шард будет направлен запрос.
- **Config-сервер (configSrv)**: хранит метаданные кластера (маппинг данных кластера на шарды).

**Схема шардирования с репликацией** (второй вариант) доступен в [Google Drive](https://drive.google.com/file/d/1pNo0Ynpk6ZjZftUZAoFlRIByqkp8VaI3/view?usp=share_link) на странице `replication`.

### Шаг 3. Кэширование с помощью Redis

Для дальнейшего повышения производительности используется **кэширование** по паттерну **Cache Aside**. В качестве сервиса кэширования выбран Redis, поскольку он предоставляет:
- Высокую скорость чтения данных из памяти
- Возможность репликации и шардирования (разделения данных на сегменты)

**Redis Cluster** состоит из трёх сегментов (минимум для обеспечения устойчивой кластеризации). У каждого сегмента:
- **Master** узел (M1, M2, M3) отвечает за записи
- **Slave** узел (S1, S2, S3) хранит копии данных (репликация) и предоставляет операции чтения

При этом:
- Клиенты пишут/читают на **Master**-узлах
- На **Slave**-узлах доступна только операция чтения
- Состояние кластера координируется через протокол gossip

**Схема с кэшированием** (третий вариант) доступен в [Google Drive](https://drive.google.com/file/d/1pNo0Ynpk6ZjZftUZAoFlRIByqkp8VaI3/view?usp=share_link) на странице `caching`.

---

## Задание 2. Шардирование

Для реализации **первого шага** (шардирование в MongoDB) подготовлен файл `compose.yaml`, модифицированный на базе примера из урока по шардированию.

### Как запустить

1. Из папки с проектом перейти в папку `mongo-sharding`:
   ```bash
   cd mongo-sharding
   ```
2. Запустить MongoDB и приложение:
   ```bash
   docker compose up -d
   ```
3. Заполнить MongoDB тестовыми данными:
   ```bash
   ./scripts/mongo-init.sh
   ```
   Внутри `mongo-init.sh` происходит:
    - Подключение к серверу конфигурации и начальная инициализация.
    - Инициализация **первого шарда**.
    - Инициализация **второго шарда**.
    - Инициализация **роутера**.
    - Наполнение роутера тестовыми данными, которые в свою очередь распределяются по шардам.

### Как проверить

1. Открыть в браузере [http://localhost:8080](http://localhost:8080) — убедиться в доступности приложения.
2. При помощи shell-скрипта проверить количество документов в базе **somedb** (на инстансах `mongos_router`, `shard1` и `shard2`):
   ```bash
   ./scripts/mongo-checking-data.sh
   ```
   общее количество документов будет 1500

---

## Задание 3. Репликация
Для реализации **второго шага** (Репликация в MongoDB) подготовлен файл `compose.yaml`, модифицированный на базе `compose.yaml` из `mongo-sharding`.

### Как запустить

1. Из папки с проектом перейти в папку `mongo-sharding-repl`:
   ```bash
   cd ../
   cd mongo-sharding-repl
   ```
2. Запустить MongoDB и приложение:
   ```bash
   docker compose up -d
   ```
3. Заполнить MongoDB тестовыми данными:
   ```bash
   ./scripts/mongo-init.sh
   ```
   Внутри `mongo-init.sh` происходит:
   - Подключение к серверу конфигурации и начальная инициализация.
   - Инициализация **первой реплики первого шарда**.
   - Инициализация **второй реплики первого шарда**.
   - Инициализация **третьей реплики первого шарда**.
   - Инициализация **первой реплики второго шарда**.
   - Инициализация **второй реплики второго шарда**.
   - Инициализация **третьей реплики второго шарда**.
   - Инициализация **роутера**.
   - Наполнение роутера тестовыми данными, которые в свою очередь распределяются по шардам.

### Как проверить

1. Открыть в браузере [http://localhost:8080](http://localhost:8080) — убедиться в доступности приложения.
2. При помощи shell-скрипта проверить:
   - количество документов в базе **somedb** (на инстансах `mongos_router`, `shard1` и `shard2`)
   - количество реплик в shard1
   - количество реплик в shard2
   ```bash
   ./scripts/mongo-checking-data.sh
   ```
   общее количество документов будет 1500
   общее количество реплик в шардах будет по 3
---

## Задание 4. Кэширование (в проработке)
Настройка Redis Cluster для реализации кэширования по паттерну **Cache Aside**.

---

## Задание 5. Service Discovery и балансировка с API Gateway (в проработке)
Исследование и реализация механизма обнаружения сервисов и балансировки.

---

## Задание 6. CDN (в проработке)
Настройка сети доставки контента.

--- 